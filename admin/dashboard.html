<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Casper Youth Hub - Admin Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      :root {
        --bg-main: #0f172a;
        --bg-card: #1e293b;
        --bg-sidebar: #0a0f1a;
        --primary: #6366f1;
        --secondary: #ec4899;
        --accent: #14b8a6;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --border: #334155;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--bg-main);
        color: var(--text-primary);
        overflow: hidden;
      }

      /* Login */
      .login-wrapper {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        padding: 20px;
      }
      .login-container {
        background: var(--bg-card);
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 440px;
        overflow: hidden;
        border: 1px solid var(--border);
      }
      .login-header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        padding: 40px;
        text-align: center;
        color: white;
      }
      .login-header .logo {
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        margin-bottom: 20px;
      }
      .login-header h1 {
        font-family: "Space Grotesk", sans-serif;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
      }
      .login-body {
        padding: 40px;
      }
      .form-group {
        margin-bottom: 24px;
      }
      .form-group label {
        display: block;
        margin-bottom: 10px;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 14px;
      }
      .form-group input {
        width: 100%;
        padding: 14px 16px;
        background: var(--bg-main);
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 15px;
        color: var(--text-primary);
        font-family: inherit;
        transition: all 0.3s;
      }
      .form-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
      }
      .btn-login {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .btn-login:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
      }
      .error-message {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--error);
        color: var(--error);
        padding: 14px 16px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
        font-size: 14px;
        align-items: center;
        gap: 10px;
      }

      /* Dashboard */
      .dashboard {
        display: none;
        height: 100vh;
        grid-template-columns: 280px 1fr 400px;
        gap: 0;
      }

      /* Sidebar */
      .stats-sidebar {
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      .sidebar-header {
        padding: 30px 24px;
        border-bottom: 1px solid var(--border);
      }
      .sidebar-logo {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }
      .sidebar-logo .icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
      .sidebar-logo h1 {
        font-family: "Space Grotesk", sans-serif;
        font-size: 18px;
        font-weight: 700;
      }
      .sidebar-subtitle {
        font-size: 12px;
        color: var(--text-secondary);
        padding-left: 52px;
      }
      .stats-container {
        padding: 20px;
      }
      .stat-card-mini {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s;
      }
      .stat-card-mini:hover {
        transform: translateY(-2px);
        border-color: var(--primary);
      }
      .stat-card-mini .stat-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .stat-card-mini .stat-value {
        font-family: "Space Grotesk", sans-serif;
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
      }
      .filters-section {
        padding: 20px;
        border-top: 1px solid var(--border);
      }
      .filters-section h3 {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        margin-bottom: 16px;
      }
      .filter-group {
        margin-bottom: 16px;
      }
      .filter-group label {
        display: block;
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      .filter-group select,
      .filter-group input {
        width: 100%;
        padding: 10px 12px;
        background: var(--bg-main);
        border: 2px solid var(--border);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 13px;
        font-family: inherit;
      }
      .btn-filter,
      .btn-export,
      .btn-delete {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s;
        margin-bottom: 8px;
      }
      .btn-filter {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
      }
      .btn-export {
        background: var(--bg-card);
        color: var(--text-primary);
        border: 2px solid var(--border);
      }
      .btn-delete {
        background: var(--error);
        color: white;
      }
      .btn-delete:hover:not(:disabled) {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
      }
      .btn-delete:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #7f1d1d;
      }
      .sidebar-user {
        margin-top: auto;
        padding: 20px;
        border-top: 1px solid var(--border);
      }
      .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .user-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }
      .user-details .user-name {
        font-size: 14px;
        font-weight: 600;
      }
      .user-details .user-role {
        font-size: 12px;
        color: var(--text-secondary);
      }
      .user-details .role-badge {
        display: inline-block;
        padding: 2px 8px;
        background: rgba(236, 72, 153, 0.2);
        border: 1px solid var(--secondary);
        border-radius: 4px;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--secondary);
        margin-top: 4px;
      }
      .btn-logout {
        width: 100%;
        padding: 10px;
        background: var(--bg-card);
        border: 2px solid var(--border);
        border-radius: 10px;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s;
      }
      .btn-logout:hover {
        border-color: var(--error);
        color: var(--error);
      }

      /* Center */
      .response-viewer {
        background: var(--bg-main);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .viewer-header {
        padding: 24px 30px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .viewer-title h2 {
        font-family: "Space Grotesk", sans-serif;
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .viewer-title h2 i {
        color: var(--primary);
      }
      .viewer-counter {
        font-size: 14px;
        color: var(--text-secondary);
      }
      .search-box {
        position: relative;
        width: 280px;
      }
      .search-box i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
      }
      .search-box input {
        width: 100%;
        padding: 10px 14px 10px 42px;
        background: var(--bg-card);
        border: 2px solid var(--border);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 14px;
      }
      .viewer-body {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        overflow-y: auto;
      }
      .response-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 40px;
        max-width: 600px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.5s;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(50px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      .response-card .card-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }
      .response-id {
        display: inline-block;
        padding: 6px 14px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
      }
      .card-meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }
      .meta-item {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .meta-icon {
        width: 40px;
        height: 40px;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
      }
      .meta-info .label {
        font-size: 12px;
        color: var(--text-secondary);
      }
      .meta-info .value {
        font-size: 14px;
        font-weight: 500;
      }
      .viewer-navigation {
        padding: 24px 30px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: center;
        gap: 16px;
      }
      .btn-nav {
        padding: 12px 32px;
        background: var(--bg-card);
        border: 2px solid var(--border);
        border-radius: 12px;
        color: var(--text-primary);
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
      }
      .btn-nav:hover:not(:disabled) {
        border-color: var(--primary);
        transform: translateY(-2px);
      }
      .btn-nav:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .empty-state {
        text-align: center;
        padding: 60px 40px;
      }
      .empty-state i {
        font-size: 64px;
        color: var(--text-secondary);
        margin-bottom: 20px;
        opacity: 0.5;
      }

      /* Right Panel */
      .detail-panel {
        background: var(--bg-sidebar);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .detail-header {
        padding: 24px;
        border-bottom: 1px solid var(--border);
      }
      .detail-header h3 {
        font-family: "Space Grotesk", sans-serif;
        font-size: 16px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .detail-body {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
      }
      .response-qa {
        margin-bottom: 24px;
        padding: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
      }
      .qa-question {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
      }
      .question-icon {
        width: 32px;
        height: 32px;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        flex-shrink: 0;
      }
      .question-text {
        font-size: 14px;
        font-weight: 600;
      }
      .qa-answer {
        padding: 12px 16px 12px 44px;
        background: rgba(99, 102, 241, 0.05);
        border-radius: 8px;
        font-size: 14px;
      }

      /* PIN Modal */
      .pin-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.9);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(8px);
      }
      .pin-content {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 40px;
        max-width: 420px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid var(--border);
      }
      .pin-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, var(--error), #dc2626);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        font-size: 40px;
        color: white;
      }
      .pin-content h2 {
        font-family: "Space Grotesk", sans-serif;
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 12px;
      }
      .pin-content p {
        color: var(--text-secondary);
        margin-bottom: 24px;
      }
      .pin-input {
        width: 100%;
        padding: 16px;
        background: var(--bg-main);
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 24px;
        text-align: center;
        color: var(--text-primary);
        font-family: inherit;
        letter-spacing: 8px;
        margin-bottom: 24px;
      }
      .pin-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
      }
      .pin-buttons {
        display: flex;
        gap: 12px;
      }
      .btn-pin-cancel,
      .btn-pin-confirm {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }
      .btn-pin-cancel {
        background: var(--bg-main);
        color: var(--text-primary);
        border: 2px solid var(--border);
      }
      .btn-pin-confirm {
        background: var(--error);
        color: white;
      }
      .btn-pin-confirm:hover {
        background: #dc2626;
        transform: translateY(-2px);
      }
      .pin-error {
        color: var(--error);
        font-size: 13px;
        margin-top: 12px;
        display: none;
      }

      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
        .detail-panel {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login -->
    <div class="login-wrapper" id="loginScreen">
      <div class="login-container">
        <div class="login-header">
          <div class="logo"><i class="fas fa-users"></i></div>
          <h1>Casper Youth Hub</h1>
          <p>Admin Dashboard</p>
        </div>
        <div class="login-body">
          <div class="error-message" id="loginError">
            <i class="fas fa-exclamation-circle"></i><span></span>
          </div>
          <form id="loginForm">
            <div class="form-group">
              <label>Email</label>
              <input
                type="email"
                id="email"
                required
                placeholder="admin@example.com"
              />
            </div>
            <div class="form-group">
              <label>Password</label>
              <input
                type="password"
                id="password"
                required
                placeholder="••••••••"
              />
            </div>
            <button type="submit" class="btn-login">
              <i class="fas fa-sign-in-alt"></i>Sign In
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboardScreen">
      <!-- LEFT -->
      <aside class="stats-sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <div class="icon"><i class="fas fa-users"></i></div>
            <h1>Casper Youth Hub</h1>
          </div>
          <div class="sidebar-subtitle">Admin Dashboard</div>
        </div>
        <div class="stats-container">
          <div class="stat-card-mini">
            <div class="stat-label"><i class="fas fa-comments"></i>Total</div>
            <div class="stat-value" id="totalResponses">0</div>
          </div>
          <div class="stat-card-mini">
            <div class="stat-label">
              <i class="fas fa-calendar-day"></i>Today
            </div>
            <div class="stat-value" id="todayResponses">0</div>
          </div>
          <div class="stat-card-mini">
            <div class="stat-label"><i class="fas fa-clock"></i>Avg Time</div>
            <div class="stat-value" id="avgTime">--</div>
          </div>
          <div class="stat-card-mini">
            <div class="stat-label"><i class="fas fa-poll-h"></i>Active</div>
            <div class="stat-value" id="activeSurveys">0</div>
          </div>
        </div>
        <div class="filters-section">
          <h3>Filters</h3>
          <div class="filter-group">
            <label>Survey</label>
            <select id="surveyFilter">
              <option value="">All</option>
            </select>
          </div>
          <div class="filter-group">
            <label>From</label>
            <input type="date" id="dateFrom" />
          </div>
          <div class="filter-group">
            <label>To</label>
            <input type="date" id="dateTo" />
          </div>
          <button class="btn-filter" onclick="applyFilters()">
            <i class="fas fa-search"></i>Apply
          </button>
          <button class="btn-export" onclick="refreshResponses()">
            <i class="fas fa-sync-alt"></i>Refresh
          </button>
          <button class="btn-export" onclick="exportToCSV()">
            <i class="fas fa-download"></i>Export CSV
          </button>
          <button
            class="btn-delete"
            id="btnDeleteResponse"
            onclick="initiateDelete()"
            disabled
          >
            <i class="fas fa-trash-alt"></i>Delete Response
          </button>
        </div>
        <div class="sidebar-user">
          <div class="user-profile">
            <div class="user-avatar"><i class="fas fa-user"></i></div>
            <div class="user-details">
              <div class="user-name" id="userName">Admin</div>
              <div class="user-role" id="userRole">Loading...</div>
            </div>
          </div>
          <button class="btn-logout" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>Logout
          </button>
        </div>
      </aside>

      <!-- CENTER -->
      <main class="response-viewer">
        <div class="viewer-header">
          <div class="viewer-title">
            <h2><i class="fas fa-inbox"></i>Responses</h2>
            <div class="viewer-counter" id="responseCounter">0</div>
          </div>
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchBox" placeholder="Search..." />
          </div>
        </div>
        <div class="viewer-body" id="viewerBody">
          <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
          </div>
        </div>
        <div class="viewer-navigation">
          <button
            class="btn-nav"
            id="btnPrev"
            onclick="previousResponse()"
            disabled
          >
            <i class="fas fa-arrow-left"></i>Prev
          </button>
          <button
            class="btn-nav"
            id="btnNext"
            onclick="nextResponse()"
            disabled
          >
            Next<i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </main>

      <!-- RIGHT -->
      <aside class="detail-panel">
        <div class="detail-header">
          <h3><i class="fas fa-list"></i>Full Response</h3>
        </div>
        <div class="detail-body" id="detailBody">
          <div class="empty-state">
            <i class="fas fa-hand-pointer"></i>
            <p>Select a response</p>
          </div>
        </div>
      </aside>
    </div>

    <!-- PIN Modal -->
    <div class="pin-modal" id="pinModal">
      <div class="pin-content">
        <div class="pin-icon"><i class="fas fa-lock"></i></div>
        <h2>Admin PIN Required</h2>
        <p>Enter your admin PIN to delete this response</p>
        <input
          type="password"
          class="pin-input"
          id="pinInput"
          placeholder="••••"
          maxlength="6"
        />
        <div class="pin-error" id="pinError">
          <i class="fas fa-exclamation-circle"></i> Incorrect PIN
        </div>
        <div class="pin-buttons">
          <button class="btn-pin-cancel" onclick="closePinModal()">
            Cancel
          </button>
          <button class="btn-pin-confirm" onclick="confirmDelete()">
            Delete
          </button>
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://ecbkuzahcpmudgidcxzz.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjYmt1emFoY3BtdWRnaWRjeHp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMDUwMjAsImV4cCI6MjA3ODU4MTAyMH0.uH5YPxaM1EQ_VUC_9Dkxt6ItMM7-MLFFqXSSoQdR-xk";

      let currentUser,
        allResponses = [],
        filteredResponses = [],
        allSurveys = [],
        allQuestions = [],
        currentResponseIndex = 0;

      // Login
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("email").value,
            password = document.getElementById("password").value;
          try {
            const response = await fetch(
              `${SUPABASE_URL}/rest/v1/admins?email=eq.${email}&password=eq.${password}&select=*`,
              {
                headers: {
                  apikey: SUPABASE_ANON_KEY,
                  Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                },
              }
            );
            const admins = await response.json();
            if (admins && admins.length > 0) {
              currentUser = admins[0];
              showDashboard();
            } else showError("Invalid credentials");
          } catch (e) {
            showError("Login failed");
          }
        });

      function showError(msg) {
        const e = document.getElementById("loginError");
        e.querySelector("span").textContent = msg;
        e.style.display = "flex";
      }

      function showDashboard() {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboardScreen").style.display = "grid";
        document.getElementById("userName").textContent =
          currentUser.full_name || currentUser.email;

        // DEBUG: Log user data
        console.log("Current User:", currentUser);
        console.log("User Role:", currentUser.role);
        console.log("Admin PIN:", currentUser.admin_pin);

        // Show role badge
        const roleDiv = document.getElementById("userRole");
        if (currentUser.role === "admin") {
          roleDiv.innerHTML =
            '<span class="role-badge"><i class="fas fa-shield-alt"></i> Admin</span>';
        } else {
          roleDiv.innerHTML =
            '<span class="role-badge" style="background:rgba(100,116,139,0.2);border-color:var(--text-secondary);color:var(--text-secondary);"><i class="fas fa-user"></i> Standard User</span>';
        }

        loadDashboardData();
      }

      function logout() {
        currentUser = null;
        document.getElementById("loginScreen").style.display = "flex";
        document.getElementById("dashboardScreen").style.display = "none";
        document.getElementById("loginForm").reset();
      }

      // Load Data
      async function loadDashboardData() {
        await Promise.all([loadSurveys(), loadQuestions(), loadResponses()]);
        updateStats();
      }
      async function loadSurveys() {
        try {
          const r = await fetch(
            `${SUPABASE_URL}/rest/v1/surveys?select=*&order=created_at.desc`,
            {
              headers: {
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
            }
          );
          allSurveys = await r.json();
          const s = document.getElementById("surveyFilter");
          s.innerHTML = '<option value="">All</option>';
          allSurveys.forEach((sv) => {
            const o = document.createElement("option");
            o.value = sv.id;
            o.textContent = sv.title;
            s.appendChild(o);
          });
        } catch (e) {}
      }
      async function loadQuestions() {
        try {
          const r = await fetch(`${SUPABASE_URL}/rest/v1/questions?select=*`, {
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
          });
          allQuestions = await r.json();
        } catch (e) {}
      }
      async function loadResponses() {
        try {
          const r = await fetch(
            `${SUPABASE_URL}/rest/v1/responses?select=*,surveys(title)&order=submitted_at.desc`,
            {
              headers: {
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
            }
          );
          allResponses = await r.json();
          filteredResponses = [...allResponses];
          currentResponseIndex = 0;
          displayCurrentResponse();
        } catch (e) {}
      }

      function updateStats() {
        document.getElementById("totalResponses").textContent =
          allResponses.length;
        document.getElementById("activeSurveys").textContent =
          allSurveys.filter((s) => s.is_active).length;
        const t = new Date().toISOString().split("T")[0];
        document.getElementById("todayResponses").textContent =
          allResponses.filter((r) => r.submitted_at.startsWith(t)).length;
        document.getElementById("avgTime").textContent = "2.5m";
      }

      // Display Response
      function displayCurrentResponse() {
        const v = document.getElementById("viewerBody");
        if (filteredResponses.length === 0) {
          v.innerHTML =
            '<div class="empty-state"><i class="fas fa-inbox"></i><p>No responses</p></div>';
          document.getElementById("responseCounter").textContent = "0";
          document.getElementById("btnPrev").disabled = true;
          document.getElementById("btnNext").disabled = true;
          document.getElementById("btnDeleteResponse").disabled = true;
          return;
        }

        const r = filteredResponses[currentResponseIndex],
          d = new Date(r.submitted_at);
        v.innerHTML = `<div class="response-card"><div class="card-header"><span class="response-id">#${r.id.substring(
          0,
          8
        )}</span></div><div class="card-meta"><div class="meta-item"><div class="meta-icon"><i class="fas fa-poll"></i></div><div class="meta-info"><div class="label">Survey</div><div class="value">${
          r.surveys?.title || "Unknown"
        }</div></div></div><div class="meta-item"><div class="meta-icon"><i class="fas fa-user"></i></div><div class="meta-info"><div class="label">Email</div><div class="value">${
          r.respondent_email || "Anonymous"
        }</div></div></div><div class="meta-item"><div class="meta-icon"><i class="fas fa-calendar"></i></div><div class="meta-info"><div class="label">Date</div><div class="value">${d.toLocaleDateString()}</div></div></div><div class="meta-item"><div class="meta-icon"><i class="fas fa-clock"></i></div><div class="meta-info"><div class="label">Time</div><div class="value">${d.toLocaleTimeString()}</div></div></div></div></div>`;

        document.getElementById("responseCounter").textContent = `${
          currentResponseIndex + 1
        } of ${filteredResponses.length}`;
        document.getElementById("btnPrev").disabled =
          currentResponseIndex === 0;
        document.getElementById("btnNext").disabled =
          currentResponseIndex === filteredResponses.length - 1;

        // Enable delete button only for admins
        const isAdmin = currentUser.role === "admin";
        console.log("Checking delete button:", {
          userRole: currentUser.role,
          isAdmin: isAdmin,
          buttonWillBeEnabled: isAdmin,
        });
        document.getElementById("btnDeleteResponse").disabled = !isAdmin;

        displayResponseDetails(r);
      }

      function displayResponseDetails(r) {
        const d = document.getElementById("detailBody"),
          q = allQuestions.filter((qu) => qu.survey_id === r.survey_id);
        let h = "";
        q.forEach((qu) => {
          const a = r.response_data[qu.google_form_item_id];
          if (a !== undefined)
            h += `<div class="response-qa"><div class="qa-question"><div class="question-icon"><i class="fas fa-question"></i></div><div class="question-text">${
              qu.question_text
            }</div></div><div class="qa-answer">${
              Array.isArray(a) ? a.join(", ") : a
            }</div></div>`;
        });
        d.innerHTML =
          h ||
          '<div class="empty-state"><i class="fas fa-info"></i><p>No data</p></div>';
      }

      // Navigation
      function nextResponse() {
        if (currentResponseIndex < filteredResponses.length - 1) {
          currentResponseIndex++;
          displayCurrentResponse();
        }
      }
      function previousResponse() {
        if (currentResponseIndex > 0) {
          currentResponseIndex--;
          displayCurrentResponse();
        }
      }
      document.addEventListener("keydown", (e) => {
        if (currentUser) {
          if (e.key === "ArrowRight") nextResponse();
          if (e.key === "ArrowLeft") previousResponse();
        }
      });

      // Filters
      function applyFilters() {
        let f = [...allResponses];
        const s = document.getElementById("surveyFilter").value;
        if (s) f = f.filter((r) => r.survey_id === s);
        const df = document.getElementById("dateFrom").value,
          dt = document.getElementById("dateTo").value;
        if (df) f = f.filter((r) => r.submitted_at >= df);
        if (dt) f = f.filter((r) => r.submitted_at <= dt + "T23:59:59");
        filteredResponses = f;
        currentResponseIndex = 0;
        displayCurrentResponse();
      }
      document.getElementById("searchBox").addEventListener("input", (e) => {
        const t = e.target.value.toLowerCase();
        if (!t) {
          applyFilters();
          return;
        }
        filteredResponses = allResponses.filter(
          (r) =>
            (r.surveys?.title?.toLowerCase() || "").includes(t) ||
            (r.respondent_email?.toLowerCase() || "").includes(t) ||
            JSON.stringify(r.response_data).toLowerCase().includes(t)
        );
        currentResponseIndex = 0;
        displayCurrentResponse();
      });

      // Refresh
      async function refreshResponses() {
        const btn = document.querySelector(
          '.btn-export[onclick="refreshResponses()"]'
        );
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>Refreshing...';
        btn.disabled = true;
        try {
          await loadResponses();
          updateStats();
          applyFilters();
        } catch (e) {
          alert("Failed to refresh");
        } finally {
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      }

      // Export
      function exportToCSV() {
        if (!allResponses.length) {
          alert("No data");
          return;
        }
        const qIds = new Set();
        allResponses.forEach((r) =>
          Object.keys(r.response_data).forEach((q) => qIds.add(q))
        );
        const h = ["ID", "Survey", "Email", "Date"];
        const qMap = {};
        allQuestions.forEach(
          (q) => (qMap[q.google_form_item_id] = q.question_text)
        );
        Array.from(qIds).forEach((q) => h.push(qMap[q] || q));
        let c = h.map((h) => `"${h}"`).join(",") + "\n";
        allResponses.forEach((r) => {
          const row = [
            r.id,
            r.surveys?.title || "",
            r.respondent_email || "",
            new Date(r.submitted_at).toLocaleString(),
          ];
          Array.from(qIds).forEach((q) => row.push(r.response_data[q] || ""));
          c += row.map((cell) => `"${cell}"`).join(",") + "\n";
        });
        const b = new Blob([c], { type: "text/csv" }),
          u = URL.createObjectURL(b),
          a = document.createElement("a");
        a.href = u;
        a.download = `responses-${new Date().toISOString().split("T")[0]}.csv`;
        a.click();
        URL.revokeObjectURL(u);
      }

      // Delete Functions
      function initiateDelete() {
        if (currentUser.role !== "admin") {
          alert("Only administrators can delete responses");
          return;
        }
        if (filteredResponses.length === 0) return;
        document.getElementById("pinModal").style.display = "flex";
        document.getElementById("pinInput").value = "";
        document.getElementById("pinError").style.display = "none";
        setTimeout(() => document.getElementById("pinInput").focus(), 100);
      }

      function closePinModal() {
        document.getElementById("pinModal").style.display = "none";
      }

      async function confirmDelete() {
        const pin = document.getElementById("pinInput").value;
        const expectedPin = String(currentUser.admin_pin);

        console.log("PIN entered:", pin, "Type:", typeof pin);
        console.log("PIN expected:", expectedPin, "Type:", typeof expectedPin);
        console.log("PIN match:", pin === expectedPin);

        if (pin !== expectedPin) {
          console.log("❌ PIN incorrect!");
          document.getElementById("pinError").style.display = "block";
          return;
        }

        console.log("✅ PIN correct! Deleting immediately...");

        const response = filteredResponses[currentResponseIndex];

        console.log("Attempting to delete response:", response.id);

        try {
          const deleteResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/responses?id=eq.${response.id}`,
            {
              method: "DELETE",
              headers: {
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                "Content-Type": "application/json",
                Prefer: "return=minimal",
              },
            }
          );

          console.log("Delete response status:", deleteResponse.status);

          if (!deleteResponse.ok) {
            const errorText = await deleteResponse.text();
            console.error("Delete failed:", errorText);
            throw new Error(
              `Delete failed: ${deleteResponse.status} - ${
                errorText || "Unknown error"
              }`
            );
          }

          console.log("Successfully deleted from database");

          // Remove from arrays
          allResponses = allResponses.filter((r) => r.id !== response.id);
          filteredResponses = filteredResponses.filter(
            (r) => r.id !== response.id
          );

          // Update display
          if (currentResponseIndex >= filteredResponses.length) {
            currentResponseIndex = Math.max(0, filteredResponses.length - 1);
          }

          closePinModal();
          updateStats();
          displayCurrentResponse();

          alert("✅ Response deleted successfully!");
        } catch (e) {
          console.error("Delete error:", e);
          alert(
            "❌ Failed to delete response:\n\n" +
              e.message +
              "\n\nCheck console (F12) for details.\n\nMake sure RLS policies allow deletes!"
          );
        }
      }

      // Enter key in PIN input
      document.getElementById("pinInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") confirmDelete();
      });
    </script>
  </body>
</html>
